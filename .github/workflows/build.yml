name: Build OFP Vulkan Renderer

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build (Windows)
    runs-on: windows-2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download Vulkan SDK Headers
      run: |
        mkdir -p $env:VULKAN_SDK\Include
        mkdir -p $env:VULKAN_SDK\Lib
        curl -sL "https://raw.githubusercontent.com/KhronosGroup/Vulkan-Headers/main/include/vulkan/vulkan.h" -o "$env:VULKAN_SDK\Include\vulkan\vulkan.h"
        curl -sL "https://raw.githubusercontent.com/KhronosGroup/Vulkan-Headers/main/include/vulkan/vulkan_core.h" -o "$env:VULKAN_SDK\Include\vulkan\vulkan_core.h"
        curl -sL "https://raw.githubusercontent.com/KhronosGroup/Vulkan-Headers/main/include/vulkan/vulkan_beta.h" -o "$env:VULKAN_SDK\Include\vulkan\vulkan_beta.h"
        curl -sL "https://raw.githubusercontent.com/KhronosGroup/Vulkan-Loader/main/loader/vk_layer_extension_utils.h" -o "$env:VULKAN_SDK\Include\vulkan\vk_layer_extension_utils.h"
        curl -sL "https://raw.githubusercontent.com/KhronosGroup/Vulkan-Loader/main/loader/vk_loader_extensions.h" -o "$env:VULKAN_SDK\Include\vulkan\vk_loader_extensions.h"
        echo "VULKAN_SDK=$env:VULKAN_SDK" >> $env:GITHUB_ENV
        echo "VULKAN_SDK Include=$env:VULKAN_SDK\Include" >> $env:GITHUB_ENV
      shell: pwsh
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
      with:
        cmakeVersion: 3.29.0
    
    - name: Configure with CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: cmake --build build --config Release --parallel 4
    
    - name: Upload DLL artifact
      uses: actions/upload-artifact@v4
      with:
        name: ofp-renderer-dll
        path: build/bin/Release/*.dll
        retention-days: 7
